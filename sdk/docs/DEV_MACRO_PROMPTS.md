# Developer Macro Prompts

Copy/paste these prompts to re-generate or validate the project. Each prompt restates file paths and acceptance criteria to keep outputs consistent.

---
## 1) Review Code Generated by Assistant
```
You are doing a focused review of all code recently generated by the assistant. Inspect these paths for correctness, safety, and consistency: Sources/HSBCPartnerSDKCore/**, Sources/HSBCPlugins/**, examples/PartnerDemoApp/**, .github/workflows/ios-sdk.yml, SECURITY_BACKLOG.md. Report bugs, regressions, and missing acceptance criteria. Do NOT modify code; produce a review summary with file:line refs and severity.
```

## 2) Review Executed Prompts History
```
Review the prompts you have executed so far to ensure requirements are fully met. Cross-check implemented files against requested goals (bridge handshake, manifest loader, api client retries/idempotency, state machine transitions, biometric plugin, demo app, CI workflow, security backlog). Report gaps or inconsistencies; do not change code.
```

## 3) Recover Project / Re-generate (One-Shot)
```
Regenerate the project from scratch to the last known state. Implement all features and files with consistency:
- Manifest + Loader + OpenAPIResolver + ApiClient with retries/idempotency (see sections below for details).
- Bridge v1.1 with handshake, origin allow-list, signed envelopes; HybridContainer + WebPolicies.
- StateMachine + RuntimeEngine + SessionManager wiring journey flow and completion mapping.
- BiometricAuth plugin + PluginRegistry.
- Demo app in examples/PartnerDemoApp (SwiftUI) with initialize/start buttons.
- CI workflow .github/workflows/ios-sdk.yml building/testing and publishing XCFramework.
- SECURITY_BACKLOG.md table.
- Tests: ManifestTests, BridgeHandshakeTests, StateMachineTests, ApiClientTests, SessionManagerTests, UI test scaffold.
Ensure all acceptance checks from each section are satisfied.
```

## 4) Public API + EventBus + Telemetry
```
Implement/verify public API surfaces:
- File: Sources/HSBCPartnerSDKCore/Public/HSBCPartnerSdk.swift (initialization, startJourney facade; UIKit fallback typealias for non-iOS).
- File: Sources/HSBCPartnerSDKCore/Runtime/EventBus.swift (journey_begin, step_enter, step_exit, api_call, bridge_message, error, result).
- File: Sources/HSBCPartnerSDKCore/Telemetry/Telemetry.swift (newTraceparent generator and withSpan timing helper).
Acceptance: Public API compiles on SwiftPM (macOS) and iOS; EventBus emits step_enter/exit; telemetry provides W3C traceparent.
```

## 5) Manifest + Loader + OpenAPIResolver + ApiClient
```
Implement/verify:
- Files: Sources/HSBCPartnerSDKCore/Manifest/ManifestModels.swift (JM v1.1 structs with AnyCodable, Step bindings/transitions); ManifestLoader.swift (load, signature verify flag, minSdk, allowedOrigins validation, schema stub).
- Files: Sources/HSBCPartnerSDKCore/Network/OpenAPIResolver.swift (parse OpenAPI JSON, resolve operationId, build URLRequest).
- Files: Sources/HSBCPartnerSDKCore/Network/ApiClient.swift + SdkErrorCode.swift (traceparent header, optional idempotency header, retries with backoff/jitter, status→SdkErrorCode mapping: 401/403 AUTH_EXPIRED, 408 NET_TIMEOUT, 409 w/idem IDEMPOTENT_REPLAY, 422/400 VALIDATION_FAIL, 429 RATE_LIMITED, else UNKNOWN).
Acceptance: Loader returns manifest from local file during dev; minSdk higher or allowedOrigins empty fails; resolver builds request; client retries on 429/5xx and surfaces mapped errors after max retries.
```

## 6) HybridContainer + WebPolicies + Bridge v1.1
```
Implement/verify:
- Files: Sources/HSBCPartnerSDKCore/Container/HybridContainer.swift (ASWebAuthenticationSession signInIfNeeded prefersEphemeralWebBrowserSession; presentStepWebView with guarded WKWebView, origin enforcement, no popups/nav gestures).
- File: Sources/HSBCPartnerSDKCore/Container/WebPolicies.swift (isAllowed HTTPS-only origin check; ATS/AppBoundDomains/CSP guidance comment).
- File: Sources/HSBCPartnerSDKCore/Container/Bridge.swift (v1.1 handshake: bridge_hello -> bridge_ready with sdkCapabilities, sessionProofJws, signed envelope; states notReady/ready; per-step allowedMethods; plugin dispatch via PluginRegistry; BRIDGE_FORBIDDEN/ORIGIN_BLOCKED handling; signed responses with sig).
Acceptance: bridge_hello from allowed origin → bridge_ready; blocked origin emits ORIGIN_BLOCKED; unlisted method returns BRIDGE_FORBIDDEN; Bridge can emit to page and process incoming events/requests.
```

## 7) StateMachine + RuntimeEngine + SessionManager
```
Implement/verify:
- File: Sources/HSBCPartnerSDKCore/Runtime/StateMachine.swift (currentStepId, transitions via on[name], guardExpr evaluator (== != > < && ||, dotted lookups), bindings invoking ApiClient with argsFrom, timeoutMs emits "timeout", onStepEnter/onTerminal callbacks, snapshots saved via SessionManager).
- File: Sources/HSBCPartnerSDKCore/Runtime/RuntimeEngine.swift (load manifest, resolve OpenAPI, create ApiClient, optional sign-in, wire Bridge ↔ StateMachine, present first step, map terminal to JourneyResult.completed/pending/failed with SdkErrorCode).
- File: Sources/HSBCPartnerSDKCore/Runtime/SessionManager.swift (correlationId, context/resume, idempotencyKey, Keychain snapshot {journeyId, stepPointer, idempotencyKey, ts}).
Acceptance: 3-step flow transitions correctly; timeout triggers event; guardExpr blocks/allows; bindings emit success/error; terminal step produces JourneyResult; snapshots saved on step enter/success.
```

## 8) Bridge/Biometric Plugin
```
Implement/verify:
- Files: Sources/HSBCPlugins/BiometricAuth.swift (JourneyPlugin protocol, PluginRegistry, BiometricAuthPlugin performBiometric with LocalAuthentication; returns {"biometric":"PASS"} or throws SCA_REQUIRED/USER_CANCELLED).
- Bridge integrates plugin resolution for requests and emits BRIDGE_ERROR on failures.
Acceptance: performBiometric through Bridge resolves to success on biometric-capable simulator/device or returns mapped error.
```

## 9) Manifest/Bridge/StateMachine Tests
```
Ensure tests exist and pass:
- Tests/HSBCPartnerSDKCoreTests/ManifestTests.swift (decode manifest v1.1, minSdk pass/fail, allowedOrigins non-empty).
- Tests/HSBCPartnerSDKCoreTests/BridgeHandshakeTests.swift (allowed origin -> bridge_ready with sig; blocked origin -> ORIGIN_BLOCKED).
- Tests/HSBCPartnerSDKCoreTests/StateMachineTests.swift (A→B→C, timeout event, guardExpr block/allow, bindings emit).
- Tests/HSBCPartnerSDKCoreTests/ApiClientTests.swift, SessionManagerTests.swift.
Acceptance: `swift test` passes with these suites.
```

## 10) Demo App + UI Test
```
Implement/verify:
- SwiftUI demo at examples/PartnerDemoApp/ with ContentView.swift (Initialize SDK button, Start Money Transfer button, result Text) and topController helper; PartnerDemoAppApp.swift entrypoint.
- Xcode project examples/PartnerDemoApp/PartnerDemoApp.xcodeproj including UITest target with PartnerDemoAppUITests.swift that taps Initialize/Start and asserts result contains Completed or Pending.
Acceptance: App builds; UITest runs to completion on simulator.
```

## 11) CI Workflow
```
Ensure .github/workflows/ios-sdk.yml:
- Triggers on PRs touching sdk/ and on tags v*.
- Uses Xcode 15; caches SPM.
- Runs swift build/test in sdk/.
- Runs scripts/build_xcframework.sh and uploads sdk/dist/HSBCPartnerSDKCore.xcframework (+ checksum).
- On tag, creates GitHub Release attaching XCFramework and checksum.
Acceptance: Push/tag triggers CI and produces downloadable artifact; tag v0.x.y creates release.
```

## 12) Security Backlog
```
Maintain SECURITY_BACKLOG.md with table columns Item/Owner/Priority/Status including: dual cert pinning, ATS+AppBound+CSP, attestation header X-HSBC-Attest, JWS/JWE for Bridge responses, resume token encryption/rotation, signed kill-switch, per-journey scopes, telemetry budgets (TTFP ≤1200ms 4G; p95 server step ≤800ms), chaos tests for offline/retry/idempotency.
Acceptance: Backlog present and editable as a living doc.
```
